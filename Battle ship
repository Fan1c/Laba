import tkinter as tk
from tkinter import messagebox

class BattleshipGame:
    def __init__(self, root):
        self.root = root
        self.root.title("Морской бой — 2 игрока")
        self.setup_game()

    def setup_game(self):
        self.player1_ships = [[0]*10 for _ in range(10)]
        self.player2_ships = [[0]*10 for _ in range(10)]
        self.player1_shots = [[0]*10 for _ in range(10)]
        self.player2_shots = [[0]*10 for _ in range(10)]

        self.placing_phase = True
        self.current_player_placing = 1
        self.current_ship_index = 0
        self.ships_to_place = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1]  # стандартный флот
        self.orientation = 'horizontal'

        self.create_ui()

    def create_ui(self):
        for widget in self.root.winfo_children():
            widget.destroy()

        self.status_label = tk.Label(self.root, text="", font=("Arial", 12))
        self.status_label.pack(pady=5)

        self.orientation_btn = tk.Button(
            self.root,
            text="Ориентация: Горизонтально",
            command=self.toggle_orientation
        )
        self.orientation_btn.pack(pady=5)

        boards_frame = tk.Frame(self.root)
        boards_frame.pack(pady=10)

        self.board1_frame = tk.Frame(boards_frame, relief="groove", bd=2)
        self.board1_frame.grid(row=0, column=0, padx=10)
        self.create_board(self.board1_frame, is_player1=True)

        self.board2_frame = tk.Frame(boards_frame, relief="groove", bd=2)
        self.board2_frame.grid(row=0, column=1, padx=10)
        self.create_board(self.board2_frame, is_player1=False)

        self.reset_btn = tk.Button(
            self.root,
            text="Новая игра",
            command=self.setup_game
        )
        self.reset_btn.pack(pady=10)

        self.update_status()

    def toggle_orientation(self):
        if not self.placing_phase:
            return
        self.orientation = 'vertical' if self.orientation == 'horizontal' else 'horizontal'
        text = "Ориентация: Вертикально" if self.orientation == 'vertical' else "Ориентация: Горизонтально"
        self.orientation_btn.config(text=text)

    def create_board(self, parent, is_player1):
        for i in range(10):
            for j in range(10):
                btn = tk.Button(
                    parent,
                    width=2,
                    height=1,
                    bg="lightblue",
                    command=lambda r=i, c=j, p1=is_player1: self.on_cell_click(r, c, p1)
                )
                btn.grid(row=i, column=j)

    def on_cell_click(self, row, col, is_player1_board):
        if self.placing_phase:
            if self.current_player_placing == 1 and not is_player1_board:
                return
            if self.current_player_placing == 2 and is_player1_board:
                return

            board = self.player1_ships if self.current_player_placing == 1 else self.player2_ships
            if self.try_place_ship(board, row, col, self.ships_to_place[self.current_ship_index], self.orientation):
                self.current_ship_index += 1
                self.redraw_placement_boards()
                if self.current_ship_index >= len(self.ships_to_place):
                    if self.current_player_placing == 1:
                        self.current_player_placing = 2
                        self.current_ship_index = 0
                    else:
                        self.placing_phase = False
                        self.orientation_btn.pack_forget()
                        self.current_player = 1
                        self.start_battle_phase()
                self.update_status()
        else:
            if self.current_player == 1:
                if is_player1_board or self.player2_shots[row][col] != 0:
                    return
                if self.player2_ships[row][col] == 1:
                    self.player2_shots[row][col] = 2
                    self.get_button(self.board2_frame, row, col).config(bg="red")
                    # Проверка, уничтожен ли корабль
                    if self.is_ship_sunk(self.player2_ships, self.player2_shots, row, col):
                        self.mark_surroundings(self.player2_ships, self.player2_shots, self.board2_frame, row, col)
                    if self.check_victory(self.player2_ships, self.player2_shots):
                        messagebox.showinfo("Победа!", "Игрок 1 победил!")
                        self.setup_game()
                        return
                    # Ход остаётся у игрока 1
                else:
                    self.player2_shots[row][col] = 1
                    self.get_button(self.board2_frame, row, col).config(bg="white")
                    self.current_player = 2
            else:
                if not is_player1_board or self.player1_shots[row][col] != 0:
                    return
                if self.player1_ships[row][col] == 1:
                    self.player1_shots[row][col] = 2
                    self.get_button(self.board1_frame, row, col).config(bg="red")
                    if self.is_ship_sunk(self.player1_ships, self.player1_shots, row, col):
                        self.mark_surroundings(self.player1_ships, self.player1_shots, self.board1_frame, row, col)
                    if self.check_victory(self.player1_ships, self.player1_shots):
                        messagebox.showinfo("Победа!", "Игрок 2 победил!")
                        self.setup_game()
                        return
                    # Ход остаётся у игрока 2
                else:
                    self.player1_shots[row][col] = 1
                    self.get_button(self.board1_frame, row, col).config(bg="white")
                    self.current_player = 1

            self.update_status()

    def get_button(self, frame, row, col):
        return frame.grid_slaves(row=row, column=col)[0]

    def try_place_ship(self, board, start_row, start_col, size, orientation):
        coords = []
        if orientation == 'horizontal':
            if start_col + size > 10:
                return False
            coords = [(start_row, start_col + i) for i in range(size)]
        else:
            if start_row + size > 10:
                return False
            coords = [(start_row + i, start_col) for i in range(size)]

        for r, c in coords:
            for dr in [-1, 0, 1]:
                for dc in [-1, 0, 1]:
                    nr, nc = r + dr, c + dc
                    if 0 <= nr < 10 and 0 <= nc < 10:
                        if board[nr][nc] == 1:
                            return False

        for r, c in coords:
            board[r][c] = 1
        return True

    def redraw_placement_boards(self):
        self.create_board(self.board1_frame, is_player1=True)
        self.create_board(self.board2_frame, is_player1=False)
        for i in range(10):
            for j in range(10):
                if self.player1_ships[i][j] == 1:
                    self.get_button(self.board1_frame, i, j).config(bg="gray")
                if self.player2_ships[i][j] == 1:
                    self.get_button(self.board2_frame, i, j).config(bg="gray")

    def start_battle_phase(self):
        self.create_board(self.board1_frame, is_player1=True)
        self.create_board(self.board2_frame, is_player1=False)
        self.apply_shots(self.board1_frame, self.player1_shots)
        self.apply_shots(self.board2_frame, self.player2_shots)
        self.update_status()

    def apply_shots(self, frame, shots):
        for i in range(10):
            for j in range(10):
                if shots[i][j] == 1:
                    self.get_button(frame, i, j).config(bg="white")
                elif shots[i][j] == 2:
                    self.get_button(frame, i, j).config(bg="red")

    def find_ship_cells(self, ship_board, start_row, start_col):
        visited = set()
        stack = [(start_row, start_col)]
        ship_cells = []

        while stack:
            r, c = stack.pop()
            if (r, c) in visited or not (0 <= r < 10 and 0 <= c < 10):
                continue
            if ship_board[r][c] != 1:
                continue
            visited.add((r, c))
            ship_cells.append((r, c))
            # Добавляем соседей по прямой (корабль — линия!)
            stack.extend([(r-1, c), (r+1, c), (r, c-1), (r, c+1)])
        return ship_cells

    def is_ship_sunk(self, ship_board, shot_board, row, col):
        if ship_board[row][col] != 1:
            return False
        ship_cells = self.find_ship_cells(ship_board, row, col)
        return all(shot_board[r][c] == 2 for r, c in ship_cells)

    def mark_surroundings(self, ship_board, shot_board, frame, row, col):
        ship_cells = self.find_ship_cells(ship_board, row, col)
        for r, c in ship_cells:
            for dr in [-1, 0, 1]:
                for dc in [-1, 0, 1]:
                    nr, nc = r + dr, c + dc
                    if 0 <= nr < 10 and 0 <= nc < 10:
                        if shot_board[nr][nc] == 0 and ship_board[nr][nc] != 1:
                            shot_board[nr][nc] = 1
                            self.get_button(frame, nr, nc).config(bg="white")

    def check_victory(self, ships, shots):
        for i in range(10):
            for j in range(10):
                if ships[i][j] == 1 and shots[i][j] != 2:
                    return False
        return True

    def update_status(self):
        if self.placing_phase:
            ship_size = self.ships_to_place[self.current_ship_index]
            orient_text = "Горизонтально" if self.orientation == 'horizontal' else "Вертикально"
            self.status_label.config(
                text=f"Игрок {self.current_player_placing}: разместите {ship_size}-палубный корабль ({orient_text})"
            )
        else:
            self.status_label.config(text=f"Ходит Игрок {self.current_player}. Кликните по полю противника!")

if __name__ == "__main__":
    root = tk.Tk()
    game = BattleshipGame(root)
    root.mainloop()
